# ===============================================
# MODERN TMUX CONFIGURATION
# ===============================================
# All prefix keybindings are managed by tmux-which-key
# See ~/.config/tmux/plugins/tmux-which-key/config.yaml

# ===============================================
# BASIC SETTINGS
# ===============================================

# Fix terminal colors and features
set-option -sa terminal-overrides ",xterm*:Tc"
set-option -sa terminal-overrides ",alacritty:Tc"
set-option -g default-terminal "tmux-256color"

# Enable extended keys support for alacritty (CSI u / kitty keyboard protocol)
set -as terminal-features 'alacritty:extkeys'

# Ensure proper shell is used
set-option -g default-shell "/bin/zsh"

# Faster command sequences (10ms escape-time prevents flicker with rapid output)
set -s escape-time 10
set -sg repeat-time 600

# Enable extended keys (CSI u / kitty keyboard protocol)
# Required for C-Space and other modifier combinations to work properly
set -s extended-keys on

# Increase scrollback buffer
set -g history-limit 50000

# Enable focus events
set -g focus-events on

# Allow recognized escape sequences through tmux to the terminal
# 'all' only allows known DCS sequences (kitty graphics, etc.) - prevents flicker loops
# 'on' allows ANY sequence which can cause feedback loops with some CLI tools
set -g allow-passthrough all

# Enable OSC 52 clipboard integration (allows apps to set system clipboard)
set -g set-clipboard on

# Start windows and panes at 1, not 0
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on

# Disable aggressive resize - can cause flicker loops with TUI apps like Claude Code
# that update the screen in place when content exceeds visible area
setw -g aggressive-resize off

# Activity monitoring
set -g monitor-activity on
set -g activity-action none

# ===============================================
# PREFIX-LESS BINDINGS (can't be in which-key)
# ===============================================
# These don't require prefix, so they can't be discovered via which-key
# They're documented in which-key's help menu as "Alt shortcuts"

# Quick session switching with Alt+number
bind-key -n M-1 if-shell 'tmux has-session -t 1' 'switch-client -t 1'
bind-key -n M-2 if-shell 'tmux has-session -t 2' 'switch-client -t 2'
bind-key -n M-3 if-shell 'tmux has-session -t 3' 'switch-client -t 3'
bind-key -n M-4 if-shell 'tmux has-session -t 4' 'switch-client -t 4'
bind-key -n M-5 if-shell 'tmux has-session -t 5' 'switch-client -t 5'

# Quick window navigation with Alt+h/l
bind-key -n M-h previous-window
bind-key -n M-l next-window

# Quick window switching with Super+number (Super = Cmd on macOS, Ctrl+Shift on Linux)
# Define custom escape sequences as user keys, then bind them
# Terminal sends: \e[N;3P where N is window number
set -s user-keys[0] "\e[1;3P"
set -s user-keys[1] "\e[2;3P"
set -s user-keys[2] "\e[3;3P"
set -s user-keys[3] "\e[4;3P"
set -s user-keys[4] "\e[5;3P"
set -s user-keys[5] "\e[6;3P"
set -s user-keys[6] "\e[7;3P"
set -s user-keys[7] "\e[8;3P"
set -s user-keys[8] "\e[9;3P"

bind-key -n User0 select-window -t 1
bind-key -n User1 select-window -t 2
bind-key -n User2 select-window -t 3
bind-key -n User3 select-window -t 4
bind-key -n User4 select-window -t 5
bind-key -n User5 select-window -t 6
bind-key -n User6 select-window -t 7
bind-key -n User7 select-window -t 8
bind-key -n User8 select-window -t 9

# ===============================================
# COPY MODE BINDINGS (vi-style)
# ===============================================
# These are mode-specific, not prefix-triggered

bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi C-v send -X rectangle-toggle
bind-key -T copy-mode-vi y send -X copy-pipe-and-cancel 'pbcopy'
bind-key -T copy-mode-vi Escape send -X cancel
bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'pbcopy'

# ===============================================
# MOUSE CONFIGURATION
# ===============================================

set -g mouse on
bind-key -n MouseDown1Pane select-pane -t=\; send-keys -M
bind-key -n MouseDown1Status select-window -t=
bind-key -n MouseDrag1Pane if -Ft= '#{mouse_any_flag}' 'if -Ft= "#{pane_in_mode}" "copy-mode -M" "send-keys -M"' 'copy-mode -M'

# ===============================================
# PLUGIN CONFIGURATIONS
# ===============================================

# Catppuccin theme settings
set -g @catppuccin_flavour 'macchiato'
set -g @catppuccin_window_tabs_enabled on
set -g @catppuccin_date_time_text "%Y-%m-%d %H:%M"
set -g @catppuccin_user "on"
set -g @catppuccin_host "on"

# Session persistence (resurrect/continuum)
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-save-shell-history 'on'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'
set -g @continuum-boot 'on'

# FZF URL settings
set -g @fzf-url-fzf-options '-p 60%,30% --prompt="   " --border-label=" Open URL "'
set -g @fzf-url-history-limit '2000'

# Battery indicator (using nerd font icons)
set -g @batt_icon_status_charged '󰂄'
set -g @batt_icon_status_charging '󰂄'
set -g @batt_icon_status_discharging '󰁹'
set -g @batt_icon_status_attached '󰂄'
set -g @batt_icon_status_unknown '󰂑'
set -g @batt_icon_charge_tier8 '󰁹'
set -g @batt_icon_charge_tier7 '󰂁'
set -g @batt_icon_charge_tier6 '󰁿'
set -g @batt_icon_charge_tier5 '󰁾'
set -g @batt_icon_charge_tier4 '󰁽'
set -g @batt_icon_charge_tier3 '󰁼'
set -g @batt_icon_charge_tier2 '󰁻'
set -g @batt_icon_charge_tier1 '󰂎'

# Prefix highlight
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_show_sync_mode 'on'
set -g @prefix_highlight_prefix_prompt 'Wait'
set -g @prefix_highlight_copy_prompt 'Copy'
set -g @prefix_highlight_sync_prompt 'Sync'

# Which-key style menus (pre-generated from YAML config)
source-file ~/.config/tmux/which-key-init.tmux

# Complex FZF bindings (can't be in which-key due to quoting issues)
bind-key F display-popup -E -w 80% -h 80% '\
  choice=$(printf "Switch Session\nNew Session\nKill Session\nFind Window\nFind Files\nGrep Content\nLazygit\nReload Config" | fzf --prompt="Action: " --layout=reverse --border) && \
  case "$choice" in \
    "Switch Session") tmux display-popup -E "tmux list-sessions | sed \"s/:.*$//\" | fzf --reverse | xargs tmux switch-client -t" ;; \
    "New Session") tmux command-prompt -p "Session name:" "new-session -A -s %%" ;; \
    "Kill Session") tmux display-popup -E "tmux list-sessions | sed \"s/:.*$//\" | fzf --prompt=\"Kill: \" | xargs tmux kill-session -t" ;; \
    "Find Window") tmux display-popup -E "tmux list-windows -F \"#I: #W\" | fzf | cut -d: -f1 | xargs tmux select-window -t" ;; \
    "Find Files") tmux display-popup -E -w 80% -h 80% "find . -type f | fzf --preview=\"bat --color=always {}\"" ;; \
    "Grep Content") tmux display-popup -E -w 80% -h 80% "rg --color=always -n . | fzf --ansi" ;; \
    "Lazygit") tmux display-popup -E -w 90% -h 90% "lazygit" ;; \
    "Reload Config") tmux source-file ~/.tmux.conf \; display-message "Reloaded!" ;; \
  esac'

bind-key P display-popup -E -w 80% -h 60% '\
  project=$(find ~/Projects -maxdepth 1 -type d -not -path "*/.*" | sed "s|.*/||" | sort | fzf --prompt="Project: " --layout=reverse --border) && \
  session_name=$(echo "$project" | tr "." "_") && \
  tmux new-session -A -s "$session_name" -c "$HOME/Projects/$project"'

# FZF session switcher - use capital S to not conflict with which-key +Sessions
bind-key S display-popup -E "tmux list-sessions | sed 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse --prompt='Session: ' | xargs tmux switch-client -t"

# tmux-thumbs (vimium-like hints for text selection)
set -g @thumbs-key T
set -g @thumbs-alphabet qwerty-homerow
set -g @thumbs-fg-color "#cad3f5"
set -g @thumbs-bg-color "#24273a"
set -g @thumbs-hint-fg-color "#a6da95"
set -g @thumbs-hint-bg-color "#24273a"
set -g @thumbs-select-fg-color "#181926"
set -g @thumbs-select-bg-color "#f5a97f"
set -g @thumbs-command 'echo -n {} | pbcopy && tmux display-message "Copied: {}"'
set -g @thumbs-upcase-command 'echo -n {} | pbcopy && tmux paste-buffer'
set -g @thumbs-regexp-1 '[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+'
set -g @thumbs-regexp-2 '[a-f0-9]{7,40}'

# ===============================================
# OVERRIDE PLUGIN DEFAULTS (must be last)
# ===============================================

# Ensure our prefix key is used
# Note: C-Space is the logical name, but terminals send it as C-@ (NUL byte)
# We bind both for compatibility with terminals that support extended keys vs traditional
set -g prefix 'C-Space'
unbind C-b
bind-key 'C-Space' send-prefix
bind-key 'C-@' send-prefix

# Override sensible plugin's default-command
set-option -g default-command ""

# Unbind default keys that we're reassigning
unbind p  # was: previous-window
unbind s  # was: choose-tree
unbind w  # was: choose-window

# Create command aliases for direct submenu access
# Using the same pattern as which-key-init.tmux for proper format expansion
set -gF command-alias[210] show-wk-panes='display-menu -x C -y C -T "#[align=centre,bold,fg=green]+Panes" #{@wk_menu_panes}'
set -gF command-alias[211] show-wk-sessions='display-menu -x C -y C -T "#[align=centre,bold,fg=blue]+Sessions" #{@wk_menu_sessions}'
set -gF command-alias[212] show-wk-windows='display-menu -x C -y C -T "#[align=centre,bold,fg=yellow]+Windows" #{@wk_menu_windows}'
set -gF command-alias[213] show-wk-git='display-menu -x C -y C -T "#[align=centre,bold,fg=magenta]+Git" #{@wk_menu_git}'
set -gF command-alias[214] show-wk-find='display-menu -x C -y C -T "#[align=centre,bold,fg=cyan]+Find" #{@wk_menu_find}'
set -gF command-alias[215] show-wk-help='display-menu -x C -y C -T "#[align=centre,bold,fg=white]+Help" #{@wk_menu_help}'

# Direct submenu bindings
bind-key p show-wk-panes
bind-key s show-wk-sessions
bind-key w show-wk-windows
bind-key g show-wk-git
bind-key f show-wk-find
bind-key ? show-wk-help

# Window navigation
bind-key N previous-window
bind-key n next-window

# ===============================================
# STATUS LINE (Catppuccin Macchiato colors)
# ===============================================

set -g status on
set -g status-interval 5
set -g status-position top
set -g status-justify left
set -g status-left-length 100
set -g status-right-length 100

# Status bar colors
set -g status-style "bg=#24273a,fg=#cad3f5"

# Left: session name highlighted
set -g status-left '#[bg=#8aadf4,fg=#24273a,bold] #S #[bg=#24273a,fg=#8aadf4]'

# Right: zoom indicator (when zoomed) + prefix indicator + battery + time + date
# Shows "󰁌 ZOOMED 2/3" when zoomed (pane 2 of 3), nothing when not zoomed
set -g status-right '#{?window_zoomed_flag,#[fg=#f5a97f,bold]󰁌 ZOOMED #{pane_index}/#{window_panes} #[fg=#494d64]| ,}#{prefix_highlight} #[fg=#eed49f]#{battery_icon_charge} #{battery_percentage} #[fg=#494d64]| #[fg=#a6da95]%H:%M #[fg=#494d64]| #[fg=#8aadf4]%a %d %b'

# Window list - inactive windows (dimmed)
set -g window-status-format '#[fg=#6e738d] #I:#W '

# Window list - CURRENT window (highlighted with background)
# Shows zoom icon if zoomed: "1:nvim 󰁌"
set -g window-status-current-format '#[bg=#363a4f,fg=#c6a0f6,bold] #I:#W#{?window_zoomed_flag, #[fg=#f5a97f]󰁌,} #[bg=#24273a]'

# Window separator
set -g window-status-separator ''

# Pane borders
set -g pane-border-style "fg=#494d64"
set -g pane-active-border-style "fg=#8aadf4,bold"

# Pane border labels (shows at top of each pane)
set -g pane-border-status top
set -g pane-border-lines single

# Pane label format using pane_title (shows custom name if set via select-pane -T)
# Active:   blue background with title and path
# Inactive: dimmed with just title
set -g pane-border-format '#{?pane_active,#[bg=#8aadf4,fg=#24273a,bold] #{pane_index}: #{pane_title} ,#[fg=#5b6078] #{pane_index}: #{pane_title} }'

# Enable automatic pane title updates from shell
set -g allow-rename on
set -gw automatic-rename on

# Terminal title
set -g set-titles on
set -g set-titles-string "#S: #W"

# Message/command styling
set -g message-style "bg=#363a4f,fg=#cad3f5"

# Display panes settings (when you press prefix+q)
set -g display-panes-time 2000
set -g display-panes-colour "#6e738d"
set -g display-panes-active-colour "#8aadf4"

# ===============================================
# RE-RUN BATTERY PLUGIN (must be after status-right is set)
# ===============================================
# The battery plugin interpolates #{battery_*} variables at load time,
# but Home Manager loads plugins BEFORE extraConfig. Re-run to fix.
run-shell 'for f in /nix/store/*tmuxplugin-battery*/share/tmux-plugins/battery/battery.tmux; do [ -x "$f" ] && "$f" && break; done 2>/dev/null || true'
